<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twibbon Uploader</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        #container {
            width: 400px; /* Contoh: Berikan ukuran pada container */
            height: 400px; /* Contoh: Berikan ukuran pada container */
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden; /* Penting untuk canvas */
            cursor: pointer;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        #container.uploaded {
            border-style: solid;
            border-color: #3f51b5;
        }
        .image {
            max-width: 100%;
            max-height: 100%;
            display: block; /* Pastikan ini terlihat default */
            object-fit: contain;
        }
        #dropArea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 1.2em;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 10;
        }
        #dropArea.active {
            opacity: 1;
            visibility: visible;
        }
        #dropArea.dragover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #fileInput {
            display: none;
        }
        #canvas {
            display: none; /* Sembunyikan canvas secara default */
            max-width: 100%;
            max-height: 100%;
        }
        .placeholder-text {
            color: #888;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="container">
        <div id="dropArea">
            Seret & Jatuhkan Gambar Anda di Sini<br>atau Klik untuk Memilih
        </div>
        <input type="file" id="fileInput" accept="image/*">
        <div class="placeholder-text">Klik untuk mengunggah gambar Anda</div>
        <!-- Placeholder for initial image if any, or just empty if no initial image -->
        <img src="" alt="Gambar Anda" class="image" style="display:none;"> 
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const container = document.getElementById('container');
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const image = document.querySelector('.image'); // Ini akan menjadi placeholder kalau canvas belum ada
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const TWIBBON_URL = "twibbon.png"; // Pastikan path ini benar!

        function mergeImages(userImgSrc) {
            const userImg = new Image();
            const twibbon = new Image();
            let imagesLoaded = 0; // Hitung gambar yang sudah dimuat

            // Fungsi untuk memeriksa apakah kedua gambar sudah dimuat
            const checkAndDraw = () => {
                imagesLoaded++;
                if (imagesLoaded === 2) {
                    // Semua gambar sudah dimuat, sekarang gambar di canvas

                    // Ukur canvas sesuai container
                    // Pastikan container memiliki ukuran yang ditentukan di CSS
                    const rect = container.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;

                    ctx.clearRect(0, 0, canvas.width, canvas.height); // Bersihkan canvas

                    // Gambar user proporsional & center
                    // Hitung rasio untuk memastikan gambar user pas di canvas
                    const userRatio = Math.min(canvas.width / userImg.width, canvas.height / userImg.height);
                    const userScaledWidth = userImg.width * userRatio;
                    const userScaledHeight = userImg.height * userRatio;
                    const userX = (canvas.width - userScaledWidth) / 2;
                    const userY = (canvas.height - userScaledHeight) / 2;
                    ctx.drawImage(userImg, userX, userY, userScaledWidth, userScaledHeight);

                    // Gambar twibbon di atas user, mengisi seluruh canvas
                    ctx.drawImage(twibbon, 0, 0, canvas.width, canvas.height);

                    // Tampilkan canvas, sembunyikan placeholder & drop area
                    canvas.style.display = 'block';
                    image.style.display = 'none'; // Sembunyikan elemen <img> jika ada
                    dropArea.style.display = 'none'; // Sembunyikan dropArea
                    container.classList.add('uploaded'); // Tambahkan kelas untuk styling
                    document.querySelector('.placeholder-text').style.display = 'none'; // Sembunyikan teks placeholder
                }
            };

            // Tambahkan crossOrigin hanya jika gambar berasal dari domain berbeda
            // Jika twibbon.png ada di domain yang sama, ini tidak mutlak perlu
            // userImg.crossOrigin = "anonymous"; // Biarkan ini jika kamu mengantisipasi user upload dari URL
            twibbon.crossOrigin = "anonymous"; // Penting jika twibbon.png bisa dari domain lain

            userImg.onload = checkAndDraw;
            userImg.onerror = () => {
                alert('Gagal memuat gambar pengguna. Pastikan itu adalah gambar yang valid.');
                imagesLoaded = -Infinity; // Mencegah checkAndDraw dipanggil jika ada error
            };
            userImg.src = userImgSrc;

            twibbon.onload = checkAndDraw;
            twibbon.onerror = () => {
                alert('Gagal memuat twibbon. Pastikan file "twibbon.png" ada dan path-nya benar.');
                imagesLoaded = -Infinity; // Mencegah checkAndDraw dipanggil jika ada error
            };
            twibbon.src = TWIBBON_URL;
        }

        // Klik container → aktifkan overlay
        container.addEventListener('click', () => {
            // Hanya tampilkan dropArea jika belum ada gambar yang diupload
            if (!container.classList.contains('uploaded')) {
                dropArea.classList.add('active');
            }
        });

        // Klik drop area → file dialog
        dropArea.addEventListener('click', e => {
            e.stopPropagation(); // Mencegah event click di container ikut terpanggil
            fileInput.click();
        });

        // Upload file
        fileInput.addEventListener('change', e => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = ev => mergeImages(ev.target.result);
                reader.readAsDataURL(e.target.files[0]);
                dropArea.classList.remove('active'); // Sembunyikan dropArea setelah memilih file
            }
        });

        // Drag & Drop
        dropArea.addEventListener('dragover', e => {
            e.preventDefault(); // Penting untuk mengizinkan drop
            if (!dropArea.classList.contains('active')) {
                dropArea.classList.add('active'); // Aktifkan dropArea jika belum aktif
            }
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', e => {
            e.preventDefault(); // Penting untuk mengizinkan drop
            dropArea.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                const reader = new FileReader();
                reader.onload = ev => mergeImages(ev.target.result);
                reader.readAsDataURL(e.dataTransfer.files[0]);
                dropArea.classList.remove('active'); // Sembunyikan dropArea setelah drop
            }
        });

        // Menambahkan teks placeholder awal
        document.addEventListener('DOMContentLoaded', () => {
             // Pastikan elemen placeholder-text ada
             if (document.querySelector('.placeholder-text')) {
                document.querySelector('.placeholder-text').style.display = 'block';
             }
        });

    </script>
</body>
</html>
